\documentclass[main_tikz.tex]{subfiles}

\begin{document}

%\begin{frame}

\begin{tikzpicture}


\pgfmathsetmacro{\iO}{5}
\pgfmathsetmacro{\jO}{3}
\pgfmathsetmacro{\width}{10}
\pgfmathsetmacro{\height}{2}
\pgfmathsetmacro{\wspace}{1}
\pgfmathsetmacro{\K}{5}
\pgfmathsetmacro{\W}{9}
\pgfmathtruncatemacro{\k}{\K-1}
\pgfmathtruncatemacro{\w}{\W-1}
\pgfmathtruncatemacro{\ww}{\W-2}
\pgfmathsetmacro{\Lm}{12}

\node[] (Cm) {};
\node[right=\width/2+\wspace/2 of Cm.center] (Cm1) {};
\node[right=\width/2+\wspace/2 of Cm1.center] (Cm2) {};
\node[left=\width/\Lm+\wspace/2 of Cm.center] (Cm3) {};
\only<4->{

\pgfmathsetmacro{\iO}{9}
\pgfmathsetmacro{\jO}{1}
}


\only<3>{
\fill[green!20] ($ (Cm.center) + (\iO*\width /\Lm/2 - \w/2*\width /\Lm/2, 0)$) -- ++(0, -\height) -- ++(\W*\width/2/\Lm, 0) -- ++(0, \height) -- cycle;
\draw[<->, dashed] ($ (Cm.center) + (\iO*\width /\Lm/2 - \w/2*\width /\Lm/2, -\height/2.1)$) -- ++(\W*\width/2/\Lm, 0) node[midway, below, above, thick] {\hskip.5em$2W-1$ };

}
\only<5->{
\fill[green!20] ($ (Cm.center) + (\iO*\width /\Lm/2 - \w/2*\width /\Lm/2, 0)$)
	-- ++(0, -\height)
	-- ++(\ww*\width/2/\Lm, 0)
	-- ++(0, \height)
	-- cycle;
\alt<-6>{\fill[red!20]}{\fill[green!20]} (Cm1.center)
	-- ++(0, -\height)
	-- ++(\width/\Lm, 0)
	-- ++(0, \height)
	-- cycle;
}



\only<9-10>{
\fill[red!20] (Cm1.center)
	-- ++(0, -\height)
	-- ++(\ww*\width/2/\Lm, 0)
	-- ++(0, \height)
	-- cycle;
\alt<-9>{\fill[red!20]}{\fill[black!20]} ($ (Cm.center) + (\width/2, 0) $)
	-- ++(0, -\height)
	-- ++(-2*\width/\Lm, 0)
	-- ++(0, \height)
	-- cycle;
\only<10->{\fill[black!20]} (Cm1.center)
-- ++(0, -\height)
-- ++(\width/\Lm, 0)
-- ++(0, \height)
-- cycle;
}
\only<2->{
\fill[blue!50] ($ (Cm.center) + (\iO*\width /\Lm/2, -\jO*\height /\K)$)
	-- ++(0, -\height/\K)
	-- ++(\width/2/\Lm, 0)
	-- ++(0, \height/\K)
	-- cycle;
}
\only<8->{
\fill[blue!50] ($ (Cm1.center) + (\width/2/\Lm, -3*\height /\K)$)
	-- ++(0, -\height/\K)
	-- ++(\width/2/\Lm, 0)
	-- ++(0, \height/\K)
	-- cycle;
}

\draw (Cm.center)
	-- ++(\width/2, 0) node[midway, above]{$\mathcal C_m$}
	-- ++(0, -\height)
	-- ++(-\width/2, 0) node[midway, below] {$\left\lfloor\frac{L}{M}\right\rfloor$ coordinates of $Z$}
	-- cycle;
\draw (Cm1.center)
	-- ++(\width/2, 0) node[midway, above]{$\mathcal C_{m+1}$}
	-- ++(0, -\height)
	-- ++(-\width/2, 0) node[midway, below] {$\left\lfloor\frac{L}{M}\right\rfloor$ coordinates of $Z$}
	-- cycle;
\draw (Cm2.center)
	-- ++(\width/\Lm, 0) node[midway, above]{$\mathcal C_{m+2}$};
\draw[dashed] (Cm2.center)
	-- ++(\width/\Lm, 0) 
	-- ++(0, -\height)  node[midway, right] {\dots};;
\draw (Cm2.center)
	-- ++(0, -\height)
	-- ++(\width/\Lm, 0);
\draw (Cm3.center)
	-- ++(\width/\Lm, 0) node[midway, above]{$\mathcal C_{m-1}$}
	-- ++(0, -\height)
	-- ++(-\width/\Lm, 0);
\draw[dashed] (Cm3.center)
	-- ++(0, -\height) node[midway, left] {$K$ \dots};

\foreach \i in {1,...,\k}{
	\draw ($ (Cm.center) - (0, \i*\height /\K)$)
		-- ++(\width/2, 0);
	\draw ($ (Cm1.center) - (0, \i*\height /\K)$)
		-- ++(\width/2, 0);
}
\foreach \i in {1,...,\Lm}{
	\draw ($ (Cm.center) + (\i*\width/2/\Lm, 0)$)
		-- ++(0, -\height);
	\draw ($ (Cm1.center) + (\i*\width/2/\Lm, 0)$)
		-- ++(0, -\height);
}
\foreach \i in {1,...,2}{
	\draw[dashed] ($ (Cm2.center) + (\i*\width/2/\Lm, 0)$)
		-- ++(0, -\height);
	\draw[dashed] ($ (Cm3.center) + (\i*\width/2/\Lm, 0)$)
		-- ++(0, -\height);
}
\foreach \i in {1,...,\k}{
	\draw[dashed] ($ (Cm2.center) - (0, \i*\height /\K)$)
		-- ++(\width/\Lm, 0);
	\draw[dashed] ($ (Cm3.center) - (0, \i*\height /\K)$)
		-- ++(\width/\Lm, 0);
}

\visible<6-7>{
\draw[-triangle 90] ($(Cm) + (\width/2 - 1.3, .2)$)
	arc (135:40:1.5) node[midway, above] {\scriptsize$\smeq\Delta Z_{k_0}[t_0]$, $k_0$, $t_0$};
}

\end{tikzpicture}

%\end{frame}

\end{document}